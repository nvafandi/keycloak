version: "3.9"

services:
  keycloak:
    image: "quay.io/keycloak/keycloak:latest" # ganti tag ke versi tetap untuk production
    restart: unless-stopped
    command: ["start", "--proxy=edge"]
    environment:
      KC_DB: "postgres"
      KC_DB_URL_HOST: "${DB_HOST:-nurvan.my.id}"
      KC_DB_URL_PORT: "${DB_PORT:-5432}"
      KC_DB_URL_DATABASE: "${DB_NAME:-phantom}"
      KC_DB_USERNAME: "${DB_USER:-nurvan}"
      KC_DB_PASSWORD: "${DB_PASSWORD:-kmzwa88sAA}"
      KEYCLOAK_ADMIN: "${KEYCLOAK_ADMIN:-admin}"
      KEYCLOAK_ADMIN_PASSWORD: "${KEYCLOAK_ADMIN_PASSWORD:-changeme}"
      KC_PROXY: "edge"
      KC_HOSTNAME: "${KC_HOSTNAME:-}"   # optional override hostname (mis. kc.example.com)
    ports:
      - "${KEYCLOAK_HTTP_PORT:-8080}:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 8
    networks:
      - keycloak-net

networks:
  keycloak-net:
    driver: bridge